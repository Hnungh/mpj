<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>ABA KHQR Generator</title>

<!-- QR Library -->
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    #qrcode { margin-top: 20px; display: flex; justify-content: center; }
    input, select, button { padding:8px; margin:4px; font-size:16px; }
</style>
</head>

<body>
<h2>ABA KHQR Dynamic Generator</h2>

<div>
    <input type="number" step="0.01" id="amount" placeholder="ระบุจำนวนเงิน" value="1.00">
    <select id="currency">
        <option value="840">USD</option>
        <option value="116">KHR</option>
    </select>
    <button onclick="generateKHQR()">สร้าง QR Code</button>
</div>

<div id="qrcode"></div>
<p id="qr-text" style="word-break: break-all; color: #666; font-size: 12px;"></p>

<script>

// ===== CRC16 =====
function crc16(data){
    let crc=0xFFFF;
    for(let c of data){
        crc ^= c.charCodeAt(0) << 8;
        for(let i=0;i<8;i++){
            crc = (crc & 0x8000) ? (crc<<1)^0x1021 : crc<<1;
        }
    }
    return (crc & 0xFFFF).toString(16).toUpperCase().padStart(4,'0');
}

// ===== Tag Formatter =====
function tag(id,val){
    return id + val.length.toString().padStart(2,'0') + val;
}

// ===== MAIN =====
function generateKHQR(){

    const merchantID = "623C91ADA8F5";
    const merchantName = "BARDS SHOP";

    let amount = document.getElementById('amount').value;
    if(!amount || amount<=0) amount="1.00";
    amount = parseFloat(amount).toFixed(2);

    const currency = document.getElementById('currency').value;

    // ABA KHQR Structure
    let qr =
        tag("00","01") +                 // Payload
        tag("01","12") +                 // Dynamic
        tag("29",
            tag("00","abaakhppxxx@abaa")+
            tag("01",merchantID)+
            tag("02","ABA Bank")+
            tag("04","abaP2P")+
            tag("11",merchantID)
        )+
        tag("52","0000")+
        tag("53",currency)+
        tag("54",amount)+
        tag("58","KH")+
        tag("59",merchantName)+
        tag("60","Phnom Penh")+
        "6304";

    // Add CRC
    qr += crc16(qr);

    // Show text
    document.getElementById('qr-text').innerText = qr;

    // Clear old QR
    document.getElementById('qrcode').innerHTML = "";

    // Create QR
    new QRCode(document.getElementById("qrcode"),{
        text:qr,
        width:260,
        height:260,
        correctLevel:QRCode.CorrectLevel.M
    });
}

</script>
</body>
</html>
