<!doctype html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KHQR Payment - NEXUS WEAR</title>
    <script src="https://cdn.tailwindcss.com/3.4.17"></script>
    <style>
        .gradient-border { background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); padding: 2px; }
        .qr-glow { box-shadow: 0 0 40px rgba(220, 38, 38, 0.2); }
        .scan-line { position: absolute; width: 100%; height: 2px; background: #dc2626; animation: scan 2s linear infinite; opacity: 0.5; }
        @keyframes scan { 0% { top: 10%; } 100% { top: 90%; } }
        .confetti { position: absolute; width: 8px; height: 8px; animation: fall 3s ease-in-out forwards; }
        @keyframes fall { to { transform: translateY(500px) rotate(720deg); opacity: 0; } }
    </style>
</head>
<body class="h-full bg-[#0a0a0a] font-sans text-white">
    <div class="max-w-lg mx-auto px-4 py-8">
        
        <div id="waiting-state" class="text-center">
            <div class="bg-[#1a1a1a] rounded-2xl p-6 mb-6 border border-gray-800 text-left">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-gray-400 text-sm">Order: <span id="order-id" class="text-white font-mono">--</span></span>
                    <span id="countdown" class="text-red-500 font-mono text-sm">15:00</span>
                </div>
                <p class="text-gray-400 text-xs uppercase tracking-widest">Total Amount</p>
                <p id="total-amount" class="text-5xl font-bold mt-1">$0.00</p>
            </div>

            <div class="gradient-border rounded-3xl mb-8">
                <div class="bg-[#1a1a1a] rounded-3xl p-8">
                    <div class="flex items-center justify-center gap-2 mb-6 text-xl font-bold tracking-tighter">
                        <span class="text-white">KH</span><span class="text-red-600">QR</span>
                        <div class="w-px h-4 bg-gray-700 mx-2"></div>
                        <span class="text-sm text-gray-400">ABA BANK</span>
                    </div>

                    <div class="relative bg-white p-4 rounded-xl qr-glow inline-block">
                        <div class="scan-line"></div>
                        <div id="qr-code" class="w-56 h-56 flex items-center justify-center bg-gray-50">
                            </div>
                    </div>
                    
                    <div class="mt-6">
                        <p class="font-bold text-white uppercase" id="merchant-display">POEUY LOK</p>
                        <p class="text-gray-500 text-xs">Scan with ABA Mobile</p>
                    </div>
                </div>
            </div>

            <button id="simulate-btn" class="w-full bg-red-600 hover:bg-red-700 py-4 rounded-xl font-bold shadow-lg transition-all">
                CONFIRM PAYMENT
            </button>
        </div>

        <div id="success-state" class="hidden text-center py-10">
            <div id="confetti-container" class="absolute inset-0 pointer-events-none"></div>
            <div class="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" /></svg>
            </div>
            <h2 class="text-3xl font-bold mb-2">SUCCESSFUL!</h2>
            <p class="text-gray-400 mb-8">Your payment has been verified.</p>
            <button onclick="window.location.href='index.html'" class="w-full bg-[#1a1a1a] border border-gray-700 py-4 rounded-xl font-bold">CONTINUE SHOPPING</button>
        </div>

    </div>

    <script>
        const MY_CONFIG = {
            abaAccount: "013946223", 
            merchantName: "POEUY LOK",
            city: "Phnom Penh"
        };

        function createKHQR(amount, orderId) {
            const tag = (id, val) => {
                const s = val.toString();
                return id.toString().padStart(2, '0') + s.length.toString().padStart(2, '0') + s;
            };

            // โครงสร้าง Tag 29 ตาม Payload ที่คุณส่งมา (ABA P2P)
            const tag29_inner = 
                tag(0, "abaakhppxxx@aba") + 
                tag(1, "013946224") + 
                tag(2, "ABA Bank") + 
                tag(6, "abaP2P") + 
                tag(12, "623C91ADA8F5") + 
                tag(20, "013946224") + 
                tag(30, MY_CONFIG.abaAccount) + 
                tag(40, "Dual");

            let payload = "000201";
            payload += "010212"; // 12 = Dynamic
            payload += tag(29, tag29_inner);
            payload += "52040000";
            payload += "5303840"; // USD
            payload += tag(54, amount.toFixed(2));
            payload += "5802KH";
            payload += tag(59, MY_CONFIG.merchantName);
            payload += tag(60, MY_CONFIG.city);
            payload += tag(62, tag(1, orderId));
            payload += "6304"; 

            return payload;
        }

        function init() {
            const stored = sessionStorage.getItem('PENDING_ORDER');
            const data = stored ? JSON.parse(stored) : { order_id: "NW-001", total_price: "1.30" };
            const price = parseFloat(data.total_price.toString().replace('$', ''));

            document.getElementById('order-id').textContent = data.order_id;
            document.getElementById('total-amount').textContent = `$${price.toFixed(2)}`;

            const khqr = createKHQR(price, data.order_id);
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(khqr)}&ecc=H`;
            document.getElementById('qr-code').innerHTML = `<img src="${qrUrl}" class="w-full h-full">`;

            // Countdown
            let sec = 900;
            const timer = setInterval(() => {
                sec--;
                const m = Math.floor(sec/60), s = sec%60;
                document.getElementById('countdown').textContent = `${m}:${s < 10 ? '0' : ''}${s}`;
                if(sec <= 0) clearInterval(timer);
            }, 1000);

            // Success Click
            document.getElementById('simulate-btn').onclick = () => {
                document.getElementById('waiting-state').classList.add('hidden');
                document.getElementById('success-state').classList.remove('hidden');
                localStorage.removeItem('NEXUS_CART');
                createConfetti();
            };
        }

        function createConfetti() {
            const container = document.getElementById('confetti-container');
            for (let i = 0; i < 40; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.style.left = Math.random() * 100 + '%';
                c.style.backgroundColor = ['#dc2626','#ffffff','#22c55e'][Math.floor(Math.random()*3)];
                c.style.animationDelay = Math.random() * 2 + 's';
                container.appendChild(c);
            }
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
